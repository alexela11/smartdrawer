<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Users</title>

  <link rel="stylesheet" href="stalk.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<!-- üîê ADMIN SESSION GUARD -->
<script>
const user = JSON.parse(localStorage.getItem("user"));
if (!user || user.group_no !== 1) {
  window.location.href = "logol.html";
}
</script>

<!-- TOP BAR -->
<div class="top-bar">
  <a href="index.html" class="btn secondary">‚¨Ö Back</a>
  <a href="register.html" class="btn primary">‚ûï Register User</a>
  <button class="btn danger" onclick="logout()">üö™ Logout</button>
</div>

<h2>Registered Drawer Users</h2>

<!-- TABLE -->
<div class="table-wrapper">
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Staff ID</th>
        <th>RFID</th>
        <th>Fingerprint</th>
        <th>Registered At</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="userTable">
      <tr>
        <td colspan="6">Loading users...</td>
      </tr>
    </tbody>
  </table>
</div>

<!-- DELETE MODALS -->
<div id="modalStep1" class="modal hidden">
  <div class="modal-box">
    <p>Do you want to remove this user?</p>
    <div class="modal-actions">
      <button class="btn danger" onclick="goStep2()">Yes</button>
      <button class="btn secondary" onclick="closeModal()">No</button>
    </div>
  </div>
</div>

<div id="modalStep2" class="modal hidden">
  <div class="modal-box">
    <p><strong>Are you sure?</strong></p>
    <div class="modal-actions">
      <button class="btn danger" onclick="deleteUser()">Confirm</button>
      <button class="btn secondary" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- RESET PASSWORD MODAL -->
<div id="resetModal" class="modal hidden">
  <div class="modal-box">
    <h3>Reset Password</h3>
    <p id="resetUserInfo"></p>

    <input type="password" id="tempPassword" placeholder="New temporary password">

    <div class="modal-actions">
      <button class="btn primary" onclick="confirmReset()">Reset Password</button>
      <button class="btn secondary" onclick="closeReset()">Cancel</button>
    </div>
  </div>
</div>

<script>
/* ===== SUPABASE CONFIG ===== */
const SUPABASE_URL = "https://wevvbzauprknjkoozshp.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndldnZiemF1cHJrbmprb296c2hwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MTMwMDksImV4cCI6MjA4NDM4OTAwOX0.z1fjSoD9a3rCpGQTaDKazc2LBB3Cti46jMD1uAhGgsY";

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let selectedUserId = null;
let resetUser = null;

/* ===== LOAD USERS ===== */
async function loadUsers() {
  const { data, error } = await supabaseClient
    .from("users")
    .select("*")
    .order("created_at", { ascending: false });

  const table = document.getElementById("userTable");
  table.innerHTML = "";

  if (error || !data || data.length === 0) {
    table.innerHTML = `<tr><td colspan="6">No users found</td></tr>`;
    return;
  }

  data.forEach(u => {
    table.innerHTML += `
      <tr>
        <td>${u.name}</td>
        <td>${u.staff_id}</td>
        <td>${u.rfid_uid || "-"}</td>
        <td class="center">${u.fingerprint_id ? "‚úî" : "‚úñ"}</td>
        <td>${new Date(u.created_at).toLocaleString()}</td>
        <td class="center">
          <button class="btn secondary"
            onclick="openReset('${u.id}', '${u.name}', '${u.staff_id}', '${u.rfid_uid}')">
            üîë Reset
          </button>
          <button class="delete-btn"
            onclick="openDelete('${u.id}')">
            üóëÔ∏è
          </button>
        </td>
      </tr>
    `;
  });
}

loadUsers();

/* ===== DELETE FLOW ===== */
function openDelete(userId) {
  selectedUserId = userId;
  document.getElementById("modalStep1").classList.remove("hidden");
}

function goStep2() {
  document.getElementById("modalStep1").classList.add("hidden");
  document.getElementById("modalStep2").classList.remove("hidden");
}

function closeModal() {
  selectedUserId = null;
  document.getElementById("modalStep1").classList.add("hidden");
  document.getElementById("modalStep2").classList.add("hidden");
}

/* ===== FINAL REMOVE USER FLOW ===== */
async function deleteUser() {
  if (!selectedUserId) return;

  // 1Ô∏è‚É£ Get drawer user
  const { data: removedUser, error: fetchErr } = await supabaseClient
    .from("users")
    .select("*")
    .eq("id", selectedUserId)
    .single();

  if (fetchErr || !removedUser) {
    alert("User not found or already removed.");
    closeModal();
    return;
  }

  // 2Ô∏è‚É£ Archive into removed_users
  const { error: archiveErr } = await supabaseClient
    .from("removed_users")
    .insert([{
      name: removedUser.name,
      staff_id: removedUser.staff_id,
      rfid_uid: removedUser.rfid_uid,
      fingerprint_id: removedUser.fingerprint_id,
      removed_at: new Date().toISOString()
    }]);

  if (archiveErr) {
    alert("Failed to archive user. Removal cancelled.");
    console.error("ARCHIVE ERROR:", archiveErr);
    return;
  }

  // 3Ô∏è‚É£ Remove from users
  const { error: deleteErr } = await supabaseClient
    .from("users")
    .delete()
    .eq("id", selectedUserId);

  if (deleteErr) {
    alert("Failed to remove user from drawer.");
    console.error("DELETE ERROR:", deleteErr);
    return;
  }

  // 4Ô∏è‚É£ Disable login
  await supabaseClient
    .from("user_table")
    .update({ is_active: false })
    .eq("rfid_uid", removedUser.rfid_uid);

  // 5Ô∏è‚É£ Clear RFID
  await supabaseClient
    .from("user_table")
    .update({ rfid_uid: null })
    .eq("rfid_uid", removedUser.rfid_uid);

  // 6Ô∏è‚É£ Free RFID
  if (removedUser.rfid_uid) {
    await supabaseClient
      .from("rfid_cards")
      .update({ is_assigned: false })
      .eq("uid", removedUser.rfid_uid);
  }

  // 7Ô∏è‚É£ ADMIN LOG ‚Äî MUST MATCH CONSTRAINT
 const { error: logErr } = await supabaseClient
  .from("admin_logs")
  .insert([{
    admin_id: user.id,
    admin_name: user.name,
    action_type: "DELETE_USER",
    target_name: removedUser.name,
    target_staff_id: removedUser.staff_id,
    target_rfid_uid: removedUser.rfid_uid,
    description: `Admin ${user.name} removed drawer access for ${removedUser.name} (RFID: ${removedUser.rfid_uid})`,
    created_at: new Date().toISOString()   // ‚úÖ FORCE TIMESTAMP
  }]);

  if (logErr) {
    console.error("‚ùå ADMIN LOG INSERT FAILED:", logErr);
    alert("‚ö†Ô∏è Remove worked, but REPORT logging failed.\n\n" + logErr.message);
  }

  closeModal();
  loadUsers();
  alert(`User ${removedUser.name} was removed and archived successfully.`);
}

/* ===== RESET PASSWORD FLOW ===== */
function openReset(id, name, staffId, rfidUid) {
  resetUser = { id, name, staffId, rfidUid };
  document.getElementById("resetUserInfo").textContent =
    `Reset password for ${name} (RFID: ${rfidUid})`;
  document.getElementById("tempPassword").value = "";
  document.getElementById("resetModal").classList.remove("hidden");
}

function closeReset() {
  resetUser = null;
  document.getElementById("resetModal").classList.add("hidden");
}

async function confirmReset() {
  const newPass = document.getElementById("tempPassword").value;

  if (!newPass || newPass.length < 6) {
    alert("Temporary password must be at least 6 characters.");
    return;
  }

  const enc = new TextEncoder();
  const data = enc.encode(newPass);
  const hashBuf = await crypto.subtle.digest("SHA-256", data);
  const newHash = Array.from(new Uint8Array(hashBuf))
    .map(b => b.toString(16).padStart(2,"0"))
    .join("");

  const { error } = await supabaseClient
    .from("user_table")
    .update({ password_hash: newHash })
    .eq("rfid_uid", resetUser.rfidUid);

  if (error) {
    alert("Password reset failed: " + error.message);
    return;
  }

  await supabaseClient.from("admin_logs").insert([{
    admin_id: user.id,
    admin_name: user.name,
    action_type: "RESET_PASSWORD",   // ‚úÖ ALLOWED VALUE
    target_name: resetUser.name,
    target_staff_id: resetUser.staffId,
    target_rfid_uid: resetUser.rfidUid,
    description: `Admin ${user.name} reset password for ${resetUser.name} (RFID: ${resetUser.rfidUid})`
  }]);

  alert(`Password reset successful.\nTemporary password: ${newPass}`);
  closeReset();
}

/* ===== TEST ADMIN LOG INSERT ===== */
async function testLogInsert() {
  const { data, error } = await supabaseClient
    .from("admin_logs")
    .insert([{
      admin_id: user.id,
      admin_name: user.name,
      action_type: "DELETE_USER",   // ‚úÖ MUST MATCH CONSTRAINT
      target_name: "TEST_USER",
      description: "THIS IS A MANUAL TEST LOG"
    }]);

  if (error) {
    alert("‚ùå TEST INSERT FAILED:\n" + error.message);
    console.error("TEST INSERT ERROR:", error);
  } else {
    alert("‚úÖ TEST INSERT SUCCESS");
    console.log("TEST INSERT DATA:", data);
  }
}

/* ===== LOGOUT ===== */
function logout() {
  localStorage.removeItem("user");
  window.location.href = "logol.html";
}
</script>


</body>
</html>